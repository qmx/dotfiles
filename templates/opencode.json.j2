{#
  Opencode config template
  Inputs:
    - data.providers: model configs from Nix (opencode-data.json)
    - data.defaultModel, data.smallModel: model settings
    - orthancUrl: from secrets.json (optional)
#}
{
  "$schema": "https://opencode.ai/config.json",
  "provider": {
{%- for name, provider in data.providers | items %}
    "{{ name }}": {
      "npm": "{{ provider.npm }}",
      "name": "{{ provider.name }}",
      "options": {
{%- if name == "orthanc" %}
        "baseURL": "{{ orthancUrl }}/v1",
{%- elif name == "local" %}
        "baseURL": "http://localhost:8080/v1",
{%- else %}
        "baseURL": "http://localhost:8080/v1",
{%- endif %}
        "apiKey": "dummy"
      },
      "models": {{ provider.models | tojson }}
    }{% if not loop.last %},{% endif %}
{%- endfor %}
  },
  "model": "{{ data.defaultModel }}",
  "small_model": "{{ data.smallModel }}",
{%- if data.agentModels | length > 0 %}
  "agent": {
{%- for name, agent in data.agentModels | items %}
    "{{ name }}": {
      "model": "{{ agent.model }}"
{%- if agent.description %},
      "description": {{ agent.description | tojson }}
{%- endif %}
{%- if agent.mode %},
      "mode": "{{ agent.mode }}"
{%- endif %}
{%- if agent.temperature %},
      "temperature": {{ agent.temperature }}
{%- endif %}
{%- if agent.maxSteps %},
      "maxSteps": {{ agent.maxSteps }}
{%- endif %}
{%- if agent.tools | length > 0 %},
      "tools": {{ agent.tools | tojson }}
{%- endif %}
{%- if agent.prompt %},
      "prompt": {{ agent.prompt | tojson }}
{%- endif %}
    }{% if not loop.last %},{% endif %}
{%- endfor %}
  },
{%- endif %}
  "autoupdate": true,
  "mcp": {
    "brave-search": {
      "type": "local",
      "command": ["npx", "-y", "@modelcontextprotocol/server-brave-search"],
      "enabled": true,
      "environment": {
        "BRAVE_API_KEY": "${BRAVE_API_KEY}"
      }
    }
  }
}
