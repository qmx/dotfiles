{#
  Opencode config template
  Inputs:
    - data.providers: model configs from Nix (opencode-data.json)
    - data.defaultModel, data.smallModel: model settings
    - orthancUrl: from secrets.json (optional)
#}
{
  "$schema": "https://opencode.ai/config.json",
  "share": "disabled",
  "provider": {
{%- for name, provider in data.providers | items %}
    "{{ name }}": {
      "npm": "{{ provider.npm }}",
      "name": "{{ provider.name }}",
      "options": {
{%- if name == "orthanc" %}
        "baseURL": "{{ orthancUrl }}/v1",
{%- elif name == "local" %}
        "baseURL": "http://localhost:8080/v1",
{%- else %}
        "baseURL": "http://localhost:8080/v1",
{%- endif %}
        "apiKey": "dummy"
      },
      "models": {{ provider.models | tojson }}
    }{% if not loop.last %},{% endif %}
{%- endfor %}
  },
  "model": "{{ data.defaultModel }}",
{%- if data.smallModel %}
  "small_model": "{{ data.smallModel }}",
{%- endif %}
{%- if data.agentModels | length > 0 %}
  "agent": {
{%- for name, agent in data.agentModels | items %}
    "{{ name }}": {
      "model": "{{ agent.model }}"
{%- if agent.description %},
      "description": {{ agent.description | tojson }}
{%- endif %}
{%- if agent.mode %},
      "mode": "{{ agent.mode }}"
{%- endif %}
{%- if agent.temperature %},
      "temperature": {{ agent.temperature }}
{%- endif %}
{%- if agent.steps %},
      "steps": {{ agent.steps }}
{%- endif %}
{%- if agent.permission | length > 0 %},
      "permission": {{ agent.permission | tojson }}
{%- endif %}
{%- if agent.prompt %},
      "prompt": {{ agent.prompt | tojson }}
{%- endif %}
    }{% if not loop.last %},{% endif %}
{%- endfor %}
  },
{%- endif %}
{%- if data.permission | length > 0 %}
  "permission": {{ data.permission | tojson }},
{%- endif %}
  "autoupdate": true,
  "mcp": {
    "ddg-search": {
      "type": "local",
      "command": ["duckduckgo-mcp-server"],
      "enabled": true
    },
    "budgie": {
      "type": "remote",
      "url": "http://127.0.0.1:8787/mcp",
      "enabled": false,
      "timeout": 180000
    }
  }
}
