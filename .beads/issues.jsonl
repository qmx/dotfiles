{"id":"nix-1sf","title":"Add nixfmt to repo","description":"Add nixfmt for consistent Nix code formatting. Include in devShell and consider adding a pre-commit hook or CI check.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-07T16:44:30.187597497-05:00","updated_at":"2025-12-07T19:52:36.194812778-05:00","closed_at":"2025-12-07T19:52:36.194812778-05:00"}
{"id":"nix-aav","title":"Restructure models.nix: nest opencode fields in opencode attribute set instead of using comments, rename llama-models.nix to models.nix","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-07T16:38:17.788499534-05:00","updated_at":"2025-12-07T16:38:17.788499534-05:00"}
{"id":"nix-b7v","title":"Allow Claude to auto-run bd commands for issue management","description":"Add bd commands to Claude's auto-approval rules so issue management (create, update, close, ready, show) doesn't require manual approval each time. EDIT .claude/settings.json or equivalent config to add bd permissions.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-05T15:42:45.249641192-05:00","updated_at":"2025-12-05T15:42:45.249641192-05:00"}
{"id":"nix-f3j","title":"Refactor Nix config to eliminate duplication","description":"","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-05T15:33:36.704877573-05:00","updated_at":"2025-12-13T02:33:00.589202533-05:00","closed_at":"2025-12-13T02:33:00.589202533-05:00"}
{"id":"nix-f3j.1","title":"Create lib/llama-models.nix model catalog","description":"CREATE lib/llama-models.nix: All model definitions with hf, ctxSize, flashAttn, aliases, extraArgs, opencode metadata. Add model sets (base, macos, large) and helper functions (selectModels, toLlamaSwap, toOpencodeModel). CREATE lib/default.nix: Aggregator that exports mkLlamaSwapModels and mkOpencodeProvider helpers.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-05T15:33:54.469610264-05:00","updated_at":"2025-12-05T16:11:45.222885281-05:00","closed_at":"2025-12-05T16:11:45.222885281-05:00","dependencies":[{"issue_id":"nix-f3j.1","depends_on_id":"nix-f3j","type":"parent-child","created_at":"2025-12-05T15:33:54.469998315-05:00","created_by":"daemon"}]}
{"id":"nix-f3j.2","title":"Move llama-swap module to core.nix","description":"CREATE core.nix/home-manager/llama-swap/default.nix: Copy from dotfiles modules/home-manager/llama-swap/. EDIT core.nix/home-manager/default.nix: Add ./llama-swap import. EDIT modules/home-manager/default.nix: Remove llama-swap import. DELETE modules/home-manager/llama-swap/: Moved to core.nix","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-05T15:33:54.564764695-05:00","updated_at":"2025-12-07T19:06:39.840983202-05:00","closed_at":"2025-12-07T19:06:39.840983202-05:00","dependencies":[{"issue_id":"nix-f3j.2","depends_on_id":"nix-f3j","type":"parent-child","created_at":"2025-12-05T15:33:54.565082504-05:00","created_by":"daemon"}]}
{"id":"nix-f3j.3","title":"Remove unused gguf-downloader package","description":"DELETE pkgs/gguf-downloader/: No longer needed. EDIT pkgs/default.nix: Remove gguf-downloader reference if present","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-05T15:33:54.642287962-05:00","updated_at":"2025-12-07T19:09:13.207854906-05:00","closed_at":"2025-12-07T19:09:13.207854906-05:00","dependencies":[{"issue_id":"nix-f3j.3","depends_on_id":"nix-f3j","type":"parent-child","created_at":"2025-12-05T15:33:54.642875688-05:00","created_by":"daemon"}]}
{"id":"nix-f3j.4","title":"Generate opencode.json from Nix model definitions","description":"EDIT modules/home-manager/opencode/default.nix: Replace static JSON with pkgs.formats.json generation, import model catalog, inject orthancUrl from secrets. EDIT secrets.nix: Add orthancUrl field for Tailscale endpoint. DELETE modules/home-manager/opencode/opencode.json: Now generated at build time","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-05T15:33:54.820588866-05:00","updated_at":"2025-12-07T12:34:58.082725799-05:00","closed_at":"2025-12-07T12:34:58.082725799-05:00","dependencies":[{"issue_id":"nix-f3j.4","depends_on_id":"nix-f3j","type":"parent-child","created_at":"2025-12-05T15:33:54.820985703-05:00","created_by":"daemon"}]}
{"id":"nix-f3j.5","title":"Simplify host configs to use model catalog","description":"EDIT hosts/meduseld/home-manager/default.nix: Replace ~40 lines of inline models with llamaModels.selectModels call. EDIT hosts/orthanc/home-manager/default.nix: Replace ~160 lines of inline models with modelSets.base ++ modelSets.large","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-05T15:33:55.04087104-05:00","updated_at":"2025-12-05T16:17:24.627551181-05:00","closed_at":"2025-12-05T16:17:24.627551181-05:00","dependencies":[{"issue_id":"nix-f3j.5","depends_on_id":"nix-f3j","type":"parent-child","created_at":"2025-12-05T15:33:55.041263649-05:00","created_by":"daemon"}]}
{"id":"nix-f3j.6","title":"Consolidate flake.nix devShells with helper function","description":"EDIT flake.nix: Create mkDevShell helper, extract common packages/shellHook, use lib.optionalString for platform-specific sections. Reduces ~95 duplicated lines to ~30.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-05T15:33:55.272604634-05:00","updated_at":"2025-12-13T02:28:25.605409394-05:00","closed_at":"2025-12-13T02:28:25.605409394-05:00","dependencies":[{"issue_id":"nix-f3j.6","depends_on_id":"nix-f3j","type":"parent-child","created_at":"2025-12-05T15:33:55.272996372-05:00","created_by":"daemon"}]}
{"id":"nix-f3j.7","title":"Unify flake extraSpecialArgs with helper function","description":"EDIT flake.nix: Create mkExtraSpecialArgs helper, update all 4 homeConfigurations to use it instead of duplicated attrsets.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-05T15:33:55.497140066-05:00","updated_at":"2025-12-13T02:32:52.414323119-05:00","closed_at":"2025-12-13T02:32:52.414323119-05:00","dependencies":[{"issue_id":"nix-f3j.7","depends_on_id":"nix-f3j","type":"parent-child","created_at":"2025-12-05T15:33:55.497483122-05:00","created_by":"daemon"}]}
{"id":"nix-f3j.8","title":"Migrate secrets from git-crypt to pure Nix solution","description":"Current git-crypt setup requires --impure flag for home-manager switch. Investigate alternatives: agenix, sops-nix, or ragenix. Goal: secrets management that works with pure Nix evaluation. EDIT secrets.nix and any modules that read secrets.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-05T15:36:03.000787015-05:00","updated_at":"2025-12-05T15:36:58.469189288-05:00","closed_at":"2025-12-05T15:36:58.469189288-05:00","dependencies":[{"issue_id":"nix-f3j.8","depends_on_id":"nix-f3j","type":"parent-child","created_at":"2025-12-05T15:36:03.001172965-05:00","created_by":"daemon"}]}
{"id":"nix-j33","title":"Add .mcp.json with mcp-nixos server configuration","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-07T14:17:13.232156399-05:00","updated_at":"2025-12-07T14:17:13.232156399-05:00"}
{"id":"nix-kd4","title":"Remove small-models group override from meduseld","description":"","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-07T18:35:14.106307664-05:00","updated_at":"2025-12-07T18:35:26.315069838-05:00","closed_at":"2025-12-07T18:35:26.315069838-05:00"}
{"id":"nix-n4x","title":"Improve /commit slash command to default to granular commits - when multiple unrelated changes are present, should default to splitting into separate commits rather than asking","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-07T14:15:43.509229642-05:00","updated_at":"2025-12-07T14:15:43.509229642-05:00"}
{"id":"nix-ns7","title":"Remove small-models group override from meduseld","description":"The meduseld host config defines a custom 'small-models' group and overrides models to use it via withGroups mapAttrs. This is redundant now that the model catalog has proper group support via the 'coding' group. Should remove the withGroups override and use catalog groups directly.","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-07T18:35:26.337095631-05:00","updated_at":"2025-12-07T19:09:13.190980511-05:00","closed_at":"2025-12-07T19:09:13.190980511-05:00"}
{"id":"nix-ozo","title":"Update CLAUDE.md with nix-prefetch-github instructions","description":"Add instructions showing how to run nix-prefetch-github properly using 'nix run nixpkgs#nix-prefetch-github -- owner repo --rev tag' instead of assuming the tool is installed directly.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-08T08:58:24.551828301-05:00","updated_at":"2025-12-13T14:23:05.669121835-05:00","closed_at":"2025-12-13T14:23:05.669121835-05:00"}
{"id":"nix-r1c","title":"Migrate secrets from git-crypt to pure Nix solution","description":"## Problem\n\nCurrent git-crypt setup requires `--impure` flag for home-manager switch because `secrets.nix` uses `builtins.getEnv \"HOME\"` at evaluation time.\n\n## Research Summary\n\n### Options Evaluated\n\n| Approach | Complexity | Templating | Verdict |\n|----------|------------|------------|---------|\n| agenix | Medium | None built-in | One file per secret, awkward for structured data |\n| sops-nix | High | `${config.sops.placeholder.x}` | Full sops setup, .sops.yaml rules |\n| scalpel | Medium | `\\!\\!PLACEHOLDER\\!\\!` | Works with any backend |\n| Surma's approach | Low | None | Simple age, custom module |\n| envsubst | Low | `${VAR}` | Bad for arrays/complex JSON |\n| **minijinja + age** | Low | `{{ x \\| tojson }}` | Best fit - handles complex structures |\n\n### Key Insight\n\nThe problem is reading secrets at **evaluation time** (requires --impure). Solution: decrypt and render templates at **activation time** (pure).\n\n### Chosen Approach: age + minijinja\n\n1. **age** for encryption (like Surma's nixenv) - simple, uses SSH keys\n2. **minijinja** for templating - Rust-based (9MB), has `tojson` filter for valid JSON output\n\n### Current Secret Consumers\n\n1. `secrets.braveApiKey` → env var in opencode module (`modules/home-manager/opencode/default.nix:127`)\n2. `secrets.orthancUrl` → embedded in opencode.json (`hosts/meduseld/home-manager/default.nix:54`)\n3. `secrets.homebridge.*` → complex nested config with cameras array (`hosts/wk3/home-manager/homebridge.nix`)\n\n### Template Example (homebridge)\n\n```jinja\n{\n  \"bridge\": {\n    \"username\": {{ bridge.username | tojson }},\n    \"pin\": {{ bridge.pin | tojson }}\n  },\n  \"cameras\": {{ cameras | tojson }}\n}\n```\n\nThe `tojson` filter handles strings, arrays, objects correctly - outputs valid JSON.\n\n## Implementation Plan\n\n1. Create `modules/secrets/default.nix` - age decryption + minijinja templating module\n2. Create `secrets/` directory with age-encrypted JSON files\n3. Create `templates/` directory with .j2 template files\n4. Migrate each consumer to use templates\n5. Remove git-crypt, delete old secrets.nix\n6. Update flake.nix to remove `secrets` from extraSpecialArgs\n\n## References\n\n- [Surma's nixenv secrets](https://github.com/surma/nixenv/tree/main/secrets)\n- [sops-nix templates](https://github.com/Mic92/sops-nix)\n- [scalpel](https://github.com/polygon/scalpel)\n- [minijinja](https://github.com/mitsuhiko/minijinja)","design":"## Module Design\n\n### secrets module (`modules/secrets/default.nix`)\n\nBased on Surma's approach with added templating support:\n\n```nix\n{\n  options.secrets = {\n    identity = mkOption {\n      type = types.path;\n      default = \"~/.config/age/keys.txt\";\n      description = \"Age identity file for decryption\";\n    };\n    \n    items = mkOption {\n      type = types.attrsOf (types.submodule {\n        options = {\n          encrypted = mkOption { type = types.path; };\n          decrypted = mkOption { type = types.path; };\n        };\n      });\n    };\n    \n    templates = mkOption {\n      type = types.attrsOf (types.submodule {\n        options = {\n          template = mkOption { type = types.path; };\n          data = mkOption { type = types.path; };  # decrypted secrets file\n          output = mkOption { type = types.path; };\n          owner = mkOption { type = types.str; default = \"$USER\"; };\n          mode = mkOption { type = types.str; default = \"0600\"; };\n        };\n      });\n    };\n  };\n  \n  config = {\n    home.activation.secrets = lib.hm.dag.entryAfter [\"writeBoundary\"] ''\n      # 1. Decrypt all secret files\n      # 2. Render all templates with minijinja\n      # 3. Set permissions\n    '';\n  };\n}\n```\n\n### File Structure\n\n```\nsecrets/\n├── config.nix           # Maps secret names to encrypted files\n├── braveApiKey.age      # Simple value\n├── orthancUrl.age       # Simple value  \n└── homebridge.json.age  # Complex structured data\n\ntemplates/\n├── opencode.json.j2     # Uses orthancUrl, braveApiKey\n└── homebridge.json.j2   # Uses homebridge.* structure\n```\n\n### Activation Flow\n\n1. `age --decrypt -i ~/.config/age/keys.txt \u003c secrets/x.age \u003e ~/.secrets/x`\n2. `minijinja templates/x.j2 ~/.secrets/data.json \u003e ~/.config/app/config.json`\n3. `chmod 0600 ~/.config/app/config.json`\n\n### Key Management\n\n```bash\n# Generate master age key (one-time, store in password manager)\nage-keygen -o master.key\n# Output: Public key: age1xxxxxxx...\n\n# Store the key contents as base64 in password manager\ncat master.key | base64\n\n# On each machine, decode and place at standard location\necho '\u003cbase64 from password manager\u003e' | base64 -d \u003e ~/.config/age/keys.txt\nchmod 600 ~/.config/age/keys.txt\n\n# Encrypt a secret using the public key\nage -r age1xxxxxxx... -o secrets/foo.age \u003c plaintext\n```\n\n### Public Key Storage\n\nStore the public key in `secrets/recipients.txt` (committed to repo):\n```\n# qmx master key\nage1xxxxxxx...\n```\n\nEncrypt with: `age -R secrets/recipients.txt -o secrets/foo.age \u003c plaintext`","acceptance_criteria":"- [ ] `home-manager switch --flake .` works WITHOUT `--impure` flag\n- [ ] All three secret consumers work: braveApiKey, orthancUrl, homebridge config\n- [ ] Secrets are age-encrypted in repo (no plaintext)\n- [ ] Templates render valid JSON for opencode.json and homebridge config.json\n- [ ] git-crypt removed from devShell and workflow\n- [ ] Documentation updated in CLAUDE.md for new secrets workflow\n- [ ] Works on all platforms: macOS (meduseld), Linux aarch64 (wk3, k01), Linux x86_64 (orthanc)","notes":"## Decision Log\n\n**Key management decision**: Master age key stored in 1Password (base64 encoded).\n\nAlternatives evaluated and rejected:\n- **age-plugin-yubikey (PIV)**: Touch required for decrypt, doesn't work for remote machines with plugged-in YubiKeys\n- **age-plugin-yubikey (no-touch)**: Security similar to file-based key, adds complexity\n- **age-plugin-gpg**: Not in nixpkgs, requires gpg-agent integration\n- **age-plugin-openpgp-card**: Additional complexity, unclear gpg-agent interaction\n- **Native age SSH support**: Doesn't work with ssh-agent/gpg-agent, requires actual key file\n\nMaster key in 1Password is simplest and meets security requirements.\n\n## Key Setup (one-time)\n\n```bash\n# Generate master age key\nage-keygen -o master.key\n# Output: Public key: age1xxxxxxx...\n\n# Store as base64 in 1Password\ncat master.key | base64\n# Save to 1Password as \"Age Master Key\"\n\n# Delete local copy\nrm master.key\n```\n\n## Per-machine Setup\n\n```bash\nmkdir -p ~/.config/age\necho '\u003cbase64 from 1Password\u003e' | base64 -d \u003e ~/.config/age/keys.txt\nchmod 600 ~/.config/age/keys.txt\n```\n\n## Encrypting Secrets\n\n```bash\n# Public key in secrets/recipients.txt\nage -R secrets/recipients.txt -o secrets/foo.age \u003c plaintext\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-05T15:36:58.523779832-05:00","updated_at":"2025-12-13T01:53:46.126254094-05:00","closed_at":"2025-12-13T01:53:46.126254094-05:00"}
{"id":"nix-r1c.1","title":"Create secrets module (modules/secrets/default.nix)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T01:37:37.951813404-05:00","updated_at":"2025-12-13T01:49:39.794888029-05:00","closed_at":"2025-12-13T01:49:39.794888029-05:00","dependencies":[{"issue_id":"nix-r1c.1","depends_on_id":"nix-r1c","type":"parent-child","created_at":"2025-12-13T01:37:37.952390953-05:00","created_by":"daemon"}]}
{"id":"nix-r1c.10","title":"Cleanup old secrets infrastructure","description":"","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-13T01:37:38.616018415-05:00","updated_at":"2025-12-13T01:49:44.185744979-05:00","closed_at":"2025-12-13T01:49:44.185744979-05:00","dependencies":[{"issue_id":"nix-r1c.10","depends_on_id":"nix-r1c","type":"parent-child","created_at":"2025-12-13T01:37:38.6163498-05:00","created_by":"daemon"}]}
{"id":"nix-r1c.11","title":"Update CLAUDE.md with secrets documentation","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T01:37:38.692882659-05:00","updated_at":"2025-12-13T01:49:44.192096641-05:00","closed_at":"2025-12-13T01:49:44.192096641-05:00","dependencies":[{"issue_id":"nix-r1c.11","depends_on_id":"nix-r1c","type":"parent-child","created_at":"2025-12-13T01:37:38.693334261-05:00","created_by":"daemon"}]}
{"id":"nix-r1c.2","title":"Encrypt secrets with age","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T01:37:38.018355223-05:00","updated_at":"2025-12-13T01:49:39.803275294-05:00","closed_at":"2025-12-13T01:49:39.803275294-05:00","dependencies":[{"issue_id":"nix-r1c.2","depends_on_id":"nix-r1c","type":"parent-child","created_at":"2025-12-13T01:37:38.018691417-05:00","created_by":"daemon"}]}
{"id":"nix-r1c.3","title":"Create env.j2 template","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T01:37:38.085730413-05:00","updated_at":"2025-12-13T01:49:39.810090349-05:00","closed_at":"2025-12-13T01:49:39.810090349-05:00","dependencies":[{"issue_id":"nix-r1c.3","depends_on_id":"nix-r1c","type":"parent-child","created_at":"2025-12-13T01:37:38.086076165-05:00","created_by":"daemon"}]}
{"id":"nix-r1c.4","title":"Create opencode.json.j2 template","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T01:37:38.161110418-05:00","updated_at":"2025-12-13T01:49:39.817328641-05:00","closed_at":"2025-12-13T01:49:39.817328641-05:00","dependencies":[{"issue_id":"nix-r1c.4","depends_on_id":"nix-r1c","type":"parent-child","created_at":"2025-12-13T01:37:38.161438076-05:00","created_by":"daemon"}]}
{"id":"nix-r1c.5","title":"Create homebridge.json.j2 template","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T01:37:38.229760854-05:00","updated_at":"2025-12-13T01:49:39.825030316-05:00","closed_at":"2025-12-13T01:49:39.825030316-05:00","dependencies":[{"issue_id":"nix-r1c.5","depends_on_id":"nix-r1c","type":"parent-child","created_at":"2025-12-13T01:37:38.23015677-05:00","created_by":"daemon"}]}
{"id":"nix-r1c.6","title":"Update flake.nix (remove secrets, add age)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T01:37:38.306252465-05:00","updated_at":"2025-12-13T01:49:44.156524147-05:00","closed_at":"2025-12-13T01:49:44.156524147-05:00","dependencies":[{"issue_id":"nix-r1c.6","depends_on_id":"nix-r1c","type":"parent-child","created_at":"2025-12-13T01:37:38.306669692-05:00","created_by":"daemon"}]}
{"id":"nix-r1c.7","title":"Migrate meduseld config","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T01:37:38.385085331-05:00","updated_at":"2025-12-13T01:49:44.164935899-05:00","closed_at":"2025-12-13T01:49:44.164935899-05:00","dependencies":[{"issue_id":"nix-r1c.7","depends_on_id":"nix-r1c","type":"parent-child","created_at":"2025-12-13T01:37:38.385507768-05:00","created_by":"daemon"}]}
{"id":"nix-r1c.8","title":"Migrate wk3 config","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T01:37:38.457796293-05:00","updated_at":"2025-12-13T01:49:44.171744572-05:00","closed_at":"2025-12-13T01:49:44.171744572-05:00","dependencies":[{"issue_id":"nix-r1c.8","depends_on_id":"nix-r1c","type":"parent-child","created_at":"2025-12-13T01:37:38.458217237-05:00","created_by":"daemon"}]}
{"id":"nix-r1c.9","title":"Migrate k01 and orthanc configs","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T01:37:38.532065935-05:00","updated_at":"2025-12-13T01:49:44.179237263-05:00","closed_at":"2025-12-13T01:49:44.179237263-05:00","dependencies":[{"issue_id":"nix-r1c.9","depends_on_id":"nix-r1c","type":"parent-child","created_at":"2025-12-13T01:37:38.532478743-05:00","created_by":"daemon"}]}
