#!/usr/bin/env bash
set -euo pipefail

# nixify-model - Add a local GGUF model to the nix-cache static store
#
# Usage: nixify-model "org/repo-GGUF:quantization"
# Example: nixify-model "unsloth/Qwen3-VL-32B-Instruct-GGUF:Q8_K_XL"

CACHE_DIR="${NIX_CACHE_DIR:-/mnt/nix-cache/static}"
MODELS_DIR="${LLAMA_MODELS_DIR:-$HOME/.local/share/llama-models}"
SECRET_KEY="${NIX_CACHE_SECRET_KEY:-$HOME/.secrets/nix-cache.sec}"

if [[ $# -lt 1 ]]; then
  echo "Usage: nixify-model <hf-identifier>"
  echo "Example: nixify-model 'unsloth/Qwen3-VL-32B-Instruct-GGUF:Q8_K_XL'"
  exit 1
fi

if [[ ! -f "$SECRET_KEY" ]]; then
  echo "Error: Signing key not found at $SECRET_KEY"
  echo "Run 'home-manager switch' to decrypt secrets first."
  exit 1
fi

HF_ID="$1"

# Parse HF ID: "org/repo-GGUF:quant" -> org, repo, quant
if [[ ! "$HF_ID" =~ ^([^/]+)/([^:]+):(.+)$ ]]; then
  echo "Error: Invalid HF identifier format"
  echo "Expected: org/repo-GGUF:quantization"
  exit 1
fi

ORG="${BASH_REMATCH[1]}"
REPO="${BASH_REMATCH[2]}"
QUANT="${BASH_REMATCH[3]}"

# Find matching local file(s)
# llama.cpp naming: org_repo_quant_filename.gguf
PATTERN="${ORG}_${REPO}_*${QUANT}*.gguf"
FILES=($(ls "$MODELS_DIR"/$PATTERN 2>/dev/null || true))

if [[ ${#FILES[@]} -eq 0 ]]; then
  echo "Error: No files found matching pattern: $PATTERN"
  echo "Looking in: $MODELS_DIR"
  exit 1
fi

echo "Found ${#FILES[@]} file(s):"
printf '  %s\n' "${FILES[@]}"

# Process each file
for FILE in "${FILES[@]}"; do
  FILENAME=$(basename "$FILE")
  # Extract just the HF filename (remove org_repo_ prefix)
  # e.g., unsloth_SmolLM3-3B-128K-GGUF_SmolLM3-3B-128K-UD-Q4_K_XL.gguf -> SmolLM3-3B-128K-UD-Q4_K_XL.gguf
  HF_FILENAME=$(echo "$FILENAME" | sed "s/^${ORG}_${REPO}_//")

  echo ""
  echo "Processing: $FILENAME"
  echo "  HF filename: $HF_FILENAME"

  # 1. Compute sha256 for ggufs catalog (SRI format)
  echo "  Computing hash..."
  FILE_HASH=$(nix hash file --sri "$FILE")
  echo "  SHA256 (SRI): $FILE_HASH"

  # 2. Add to Nix store
  echo "  Adding to Nix store..."
  STORE_PATH=$(nix store add-file --name "$HF_FILENAME" "$FILE")
  echo "  Store path: $STORE_PATH"

  # 3. Copy to cache with signing (handles NAR + narinfo + signature)
  echo "  Copying to cache with signing..."
  nix copy --to "file://${CACHE_DIR}?compression=zstd" \
    --secret-key-files "$SECRET_KEY" \
    "$STORE_PATH"
  echo "  Done!"

  # 4. Output ggufs catalog entry
  echo ""
  echo "Add to lib/models.nix ggufs section:"
  echo ""
  echo "    \"$HF_ID\" = {"
  echo "      file = \"$HF_FILENAME\";"
  echo "      sha256 = \"$FILE_HASH\";"
  echo "    };"
done

echo ""
echo "Done! Files are in $CACHE_DIR"
